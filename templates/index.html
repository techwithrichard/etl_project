<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ETL Pipeline Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            color: #333;
            background-color: #f4f4f4;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .btn {
            display: inline-block;
            background: #3498db;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            text-decoration: none;
            font-size: 16px;
            margin-right: 10px;
            margin-bottom: 10px;
            transition: background 0.3s;
        }
        
        .btn:hover {
            background: #2980b9;
        }
        
        .btn-danger {
            background: #e74c3c;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .status {
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
            background: #f8f9fa;
            border-left: 4px solid #3498db;
        }
        
        .status.success {
            border-left-color: #2ecc71;
            background: #eafaf1;
        }
        
        .status.error {
            border-left-color: #e74c3c;
            background: #fdedec;
        }
        
        .status.loading {
            border-left-color: #f39c12;
            background: #fef9e7;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 15px 0;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: bold;
        }
        
        tr:hover {
            background-color: #f5f5f5;
        }
        
        .charts {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin: 20px 0;
        }
        
        .chart-container {
            flex: 1;
            min-width: 300px;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .data-section {
            margin: 20px 0;
        }
        
        .data-table {
            overflow-x: auto;
        }
        
        .summary-item {
            display: inline-block;
            background: #eaf7ff;
            padding: 10px 15px;
            margin: 0 10px 10px 0;
            border-radius: 5px;
            border-left: 4px solid #3498db;
        }
        
        .warehouse-info {
            background: #e8f5e8;
            border-left: 4px solid #27ae60;
            padding: 15px;
            margin: 15px 0;
            border-radius: 5px;
        }
        
        @media (max-width: 768px) {
            .charts {
                flex-direction: column;
            }
            
            .btn {
                display: block;
                width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>ETL Pipeline Dashboard</h1>
            <p>Extract, Transform, Load Pipeline with Data Warehouse</p>
        </header>
        
        <div class="card">
            <h2>Pipeline Control</h2>
            <button class="btn" onclick="runETL()">Run ETL Pipeline</button>
            <button class="btn" onclick="loadData()">Refresh Data</button>
            <button class="btn" onclick="checkWarehouse()">Warehouse Status</button>
            <button class="btn" onclick="runAnalytics()">Run Analytics</button>
            <button class="btn btn-danger" onclick="clearData()">Clear Data</button>
            <div id="status" class="status">Ready to run ETL pipeline</div>
        </div>
        
        <div class="card">
            <h2>Data Summary</h2>
            <div id="summary">No data available. Run ETL pipeline to see summary.</div>
        </div>
        
        <div class="card">
            <h2>Warehouse Information</h2>
            <div id="warehouse-info">Click "Warehouse Status" to see warehouse details.</div>
        </div>
        
        <div class="card">
            <h2>Data Visualizations</h2>
            <div class="charts">
                <div class="chart-container">
                    <h3>Student Scores</h3>
                    <canvas id="scoresChart"></canvas>
                </div>
                <div class="chart-container">
                    <h3>Weather Data</h3>
                    <canvas id="weatherChart"></canvas>
                </div>
            </div>
        </div>
        
        <div class="card">
            <h2>Extracted Data</h2>
            <div id="data">No data available. Run ETL pipeline to see data.</div>
        </div>
    </div>

    <script>
        // Global variables to store chart instances
        let scoresChart = null;
        let weatherChart = null;
        
        function runETL() {
            setStatus('Running ETL pipeline...', 'loading');
            
            fetch('/run_etl')
                .then(response => response.json())
                .then(data => {
                    if (data && data.success) {
                        setStatus('ETL completed successfully!', 'success');
                        displayData(data);
                    } else {
                        setStatus('Error: ' + (data.error || 'Unknown error'), 'error');
                    }
                })
                .catch(error => {
                    setStatus('Error: ' + error.message, 'error');
                    console.error('Error:', error);
                });
        }
        
        function loadData() {
            setStatus('Loading data...', 'loading');
            
            fetch('/get_data')
                .then(response => response.json())
                .then(data => {
                    if (data && data.success) {
                        setStatus('Data loaded successfully!', 'success');
                        displayData(data);
                    } else {
                        setStatus(data.error || 'No data available', 'error');
                    }
                })
                .catch(error => {
                    setStatus('Error loading data: ' + error.message, 'error');
                    console.error('Error:', error);
                });
        }
        
        function checkWarehouse() {
            setStatus('Checking warehouse status...', 'loading');
            
            fetch('/warehouse/summary')
                .then(response => response.json())
                .then(data => {
                    if (data && data.success) {
                        setStatus('Warehouse status loaded!', 'success');
                        displayWarehouseInfo(data.summary);
                    } else {
                        setStatus('Error: ' + (data.error || 'Unknown error'), 'error');
                    }
                })
                .catch(error => {
                    setStatus('Error: ' + error.message, 'error');
                    console.error('Error:', error);
                });
        }
        
        function runAnalytics() {
            setStatus('Running analytics...', 'loading');
            
            fetch('/warehouse/analytics')
                .then(response => response.json())
                .then(data => {
                    if (data && data.success) {
                        setStatus('Analytics completed!', 'success');
                        displayAnalytics(data.analytics);
                    } else {
                        setStatus('Error: ' + (data.error || 'Unknown error'), 'error');
                    }
                })
                .catch(error => {
                    setStatus('Error: ' + error.message, 'error');
                    console.error('Error:', error);
                });
        }
        
        function clearData() {
            if (!confirm('Are you sure you want to clear all data? This action cannot be undone.')) {
                return;
            }
            
            setStatus('Clearing data...', 'loading');
            
            // Clear the UI first
            document.getElementById('summary').innerHTML = 'No data available. Run ETL pipeline to see summary.';
            document.getElementById('data').innerHTML = 'No data available. Run ETL pipeline to see data.';
            document.getElementById('warehouse-info').innerHTML = 'Click "Warehouse Status" to see warehouse details.';
            
            // Clear charts
            if (scoresChart) {
                scoresChart.destroy();
                scoresChart = null;
            }
            if (weatherChart) {
                weatherChart.destroy();
                weatherChart = null;
            }
            
            // Clear server data
            fetch('/clear_data', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                setStatus('Data cleared successfully!', 'success');
            })
            .catch(error => {
                setStatus('UI cleared, but server clearing failed', 'error');
                console.error('Error:', error);
            });
        }
        
        function setStatus(message, type = '') {
            const statusElement = document.getElementById('status');
            statusElement.textContent = message;
            statusElement.className = 'status ' + type;
        }
        
        function displayData(data) {
            if (!data || !data.data) return;
            
            // Display summary
            displaySummary(data.summary);
            
            // Display data tables
            displayDataTables(data.data);
            
            // Create charts
            createCharts(data.data);
        }
        
        function displaySummary(summary) {
            if (!summary) return;
            
            let summaryHTML = '<div class="summary-item">';
            if (summary.run_id) {
                summaryHTML += `<strong>Run ID:</strong> ${summary.run_id}<br>`;
            }
            if (summary.processed_at) {
                summaryHTML += `<strong>Processed:</strong> ${summary.processed_at}<br>`;
            }
            if (summary.record_counts) {
                summaryHTML += '<strong>Records:</strong><br>';
                Object.entries(summary.record_counts).forEach(([dataset, count]) => {
                    summaryHTML += `  ${dataset}: ${count}<br>`;
                });
            }
            summaryHTML += '</div>';
            
            document.getElementById('summary').innerHTML = summaryHTML;
        }
        
        function displayWarehouseInfo(summary) {
            if (!summary) return;
            
            let warehouseHTML = '<div class="warehouse-info">';
            warehouseHTML += '<h3>Warehouse Statistics</h3>';
            
            Object.entries(summary).forEach(([table, count]) => {
                if (table !== 'latest_run') {
                    warehouseHTML += `<div class="summary-item"><strong>${table}:</strong> ${count} records</div>`;
                }
            });
            
            if (summary.latest_run) {
                const latest = summary.latest_run;
                warehouseHTML += '<h4>Latest Pipeline Run</h4>';
                warehouseHTML += `<div class="summary-item"><strong>Run ID:</strong> ${latest.run_id}</div>`;
                warehouseHTML += `<div class="summary-item"><strong>Status:</strong> ${latest.status}</div>`;
                warehouseHTML += `<div class="summary-item"><strong>Records:</strong> ${latest.records_processed}</div>`;
                warehouseHTML += `<div class="summary-item"><strong>Start:</strong> ${latest.start_time}</div>`;
                warehouseHTML += `<div class="summary-item"><strong>End:</strong> ${latest.end_time}</div>`;
            }
            
            warehouseHTML += '</div>';
            document.getElementById('warehouse-info').innerHTML = warehouseHTML;
        }
        
        function displayAnalytics(analytics) {
            if (!analytics) return;
            
            let analyticsHTML = '<div class="warehouse-info">';
            analyticsHTML += '<h3>Analytics Results</h3>';
            
            Object.entries(analytics).forEach(([dataset, data]) => {
                analyticsHTML += `<h4>${dataset.toUpperCase()}</h4>`;
                Object.entries(data).forEach(([key, value]) => {
                    if (typeof value === 'object') {
                        analyticsHTML += `<div class="summary-item"><strong>${key}:</strong><br>`;
                        Object.entries(value).forEach(([k, v]) => {
                            analyticsHTML += `  ${k}: ${v}<br>`;
                        });
                        analyticsHTML += '</div>';
                    } else {
                        analyticsHTML += `<div class="summary-item"><strong>${key}:</strong> ${value}</div>`;
                    }
                });
            });
            
            analyticsHTML += '</div>';
            document.getElementById('warehouse-info').innerHTML = analyticsHTML;
        }
        
        function displayDataTables(data) {
            if (!data) return;
            
            let dataHTML = '';
            
            Object.entries(data).forEach(([datasetName, records]) => {
                if (Array.isArray(records) && records.length > 0) {
                    dataHTML += `<div class="data-section">`;
                    dataHTML += `<h3>${datasetName.toUpperCase()} (${records.length} records)</h3>`;
                    dataHTML += `<div class="data-table">`;
                    dataHTML += '<table>';
                    
                    // Create header
                    const headers = Object.keys(records[0]);
                    dataHTML += '<tr>';
                    headers.forEach(header => {
                        dataHTML += `<th>${header}</th>`;
                    });
                    dataHTML += '</tr>';
                    
                    // Create rows (limit to first 10 for display)
                    records.slice(0, 10).forEach(record => {
                        dataHTML += '<tr>';
                        headers.forEach(header => {
                            const value = record[header];
                            // Handle null, undefined, and NaN values gracefully
                            if (value === null || value === undefined || value === 'NaN' || value === 'nan' || value === 'NAN') {
                                dataHTML += `<td><em>N/A</em></td>`;
                            } else {
                                dataHTML += `<td>${value}</td>`;
                            }
                        });
                        dataHTML += '</tr>';
                    });
                    
                    dataHTML += '</table>';
                    if (records.length > 10) {
                        dataHTML += `<p><em>Showing first 10 of ${records.length} records</em></p>`;
                    }
                    dataHTML += '</div></div>';
                }
            });
            
            document.getElementById('data').innerHTML = dataHTML || 'No data available';
        }
        
        function createCharts(data) {
            // Clear existing charts
            if (scoresChart) {
                scoresChart.destroy();
                scoresChart = null;
            }
            if (weatherChart) {
                weatherChart.destroy();
                weatherChart = null;
            }
            
            // Create scores chart
            if (data.scores && Array.isArray(data.scores) && data.scores.length > 0) {
                const scoresCtx = document.getElementById('scoresChart');
                if (scoresCtx) {
                    const names = data.scores.map(item => item.Student_ID || item.student_id || 'Unknown');
                    const scores = data.scores.map(item => item.Score || item.score || 0);
                    
                    scoresChart = new Chart(scoresCtx, {
                        type: 'bar',
                        data: {
                            labels: names,
                            datasets: [{
                                label: 'Scores',
                                data: scores,
                                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Student Scores'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    max: 100
                                }
                            }
                        }
                    });
                }
            }
            
            // Create weather chart
            if (data.weather && Array.isArray(data.weather) && data.weather.length > 0) {
                const weatherCtx = document.getElementById('weatherChart');
                if (weatherCtx) {
                    const cities = data.weather.map(item => item.city || 'Unknown');
                    const temps = data.weather.map(item => item.temperature || 0);
                    
                    weatherChart = new Chart(weatherCtx, {
                        type: 'line',
                        data: {
                            labels: cities,
                            datasets: [{
                                label: 'Temperature (°C)',
                                data: temps,
                                borderColor: 'rgba(255, 99, 132, 1)',
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                tension: 0.1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                title: {
                                    display: true,
                                    text: 'Weather by City'
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    title: {
                                        display: true,
                                        text: 'Temperature (°C)'
                                    }
                                }
                            }
                        }
                    });
                }
            }
        }
        
        // Load data when page loads
        window.onload = function() {
            console.log('Dashboard loaded successfully');
            // Load initial data after a short delay
            setTimeout(loadData, 500);
        };
    </script>
</body>
</html>